name: Code Review Agent (Reusable)

on:
  workflow_call:
    inputs:
      language:
        description: 'Programming language to analyze (java, python, javascript, etc)'
        required: true
        type: string
      severity:
        description: 'Minimum severity level to report (error, warning, info)'
        required: false
        default: 'warning'
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  code-review:
    name: Analyze Code & Post Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **.${{ inputs.language == 'java' && '*.java' || inputs.language == 'python' && '*.py' || inputs.language == 'javascript' && '*.js' || '**' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Checkout analyzer repo
        uses: actions/checkout@v4
        with:
          repository: bsimulator/pr-review-agent
          path: analyzer
          ref: main

      - name: Run Java Code Review
        if: inputs.language == 'java' && steps.changed-files.outputs.all_changed_files != ''
        id: java-review
        run: |
          cd analyzer/agent
          npm install 2>/dev/null || true
          
          # Run analyzer on changed Java files
          node -e "
          const fs = require('fs');
          const path = require('path');
          const javaAnalyzer = require('./src/analyzers/javaAnalyzer.js');
          
          const files = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ').filter(f => f.endsWith('.java'));
          const results = [];
          
          files.forEach(file => {
            if (fs.existsSync(file)) {
              const content = fs.readFileSync(file, 'utf8');
              const violations = javaAnalyzer.analyze(content);
              if (violations.length > 0) {
                results.push({
                  file: file,
                  violations: violations
                });
              }
            }
          });
          
          console.log(JSON.stringify(results, null, 2));
          " > /tmp/review_results.json 2>&1 || echo "[]" > /tmp/review_results.json
          
          cat /tmp/review_results.json

      - name: Run Python Code Review
        if: inputs.language == 'python' && steps.changed-files.outputs.all_changed_files != ''
        id: python-review
        run: |
          python3 -m pip install pylint flake8 -q
          
          # Run linters on changed Python files
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Analyzing $file..."
            python3 -m pylint "$file" --exit-zero --output-format=json > /tmp/pylint_$RANDOM.json 2>/dev/null || true
            python3 -m flake8 "$file" --format=json > /tmp/flake8_$RANDOM.json 2>/dev/null || true
          done

      - name: Run JavaScript Code Review
        if: inputs.language == 'javascript' && steps.changed-files.outputs.all_changed_files != ''
        id: js-review
        run: |
          npm install -g eslint @typescript-eslint/eslint-plugin @typescript-eslint/parser -q
          
          # Run eslint on changed JS files
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Analyzing $file..."
            eslint "$file" --format=json > /tmp/eslint_$RANDOM.json 2>/dev/null || true
          done

      - name: Parse Results & Generate Review Comment
        id: parse-results
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          LANGUAGE: ${{ inputs.language }}
        run: |
          # Parse Java violations from analyzer
          if [ -f /tmp/review_results.json ] && [ "${{ inputs.language }}" == "java" ]; then
            cat > /tmp/parse_violations.js << 'PARSER_EOF'
          const fs = require('fs');
          const path = require('path');
          
          try {
            const results = JSON.parse(fs.readFileSync('/tmp/review_results.json', 'utf8'));
            let markdown = '## ðŸ¤– Automated Code Review (Java)\n\n';
            
            if (!results || results.length === 0) {
              markdown += 'âœ… **No violations detected!**\n\n';
              markdown += 'All files passed code quality checks.\n';
            } else {
              let totalViolations = 0;
              let errorCount = 0;
              let warningCount = 0;
              let infoCount = 0;
              
              markdown += '### Issues Found\n\n';
              
              results.forEach(result => {
                const file = result.file;
                markdown += `#### ðŸ“„ ${file}\n\n`;
                
                if (result.violations && result.violations.length > 0) {
                  result.violations.forEach(violation => {
                    totalViolations++;
                    
                    // Severity badge
                    let badge = 'âš ï¸';
                    if (violation.severity === 'error') {
                      badge = 'âŒ';
                      errorCount++;
                    } else if (violation.severity === 'warning') {
                      badge = 'âš ï¸';
                      warningCount++;
                    } else {
                      badge = 'â„¹ï¸';
                      infoCount++;
                    }
                    
                    markdown += `${badge} **${violation.rule}** (Line ${violation.line || '?'})\n`;
                    markdown += `   ${violation.message}\n`;
                    if (violation.suggestion) {
                      markdown += `   ðŸ’¡ Suggestion: ${violation.suggestion}\n`;
                    }
                    markdown += '\n';
                  });
                } else {
                  markdown += 'âœ… No issues detected\n\n';
                }
              });
              
              markdown += `\n### Summary\n`;
              markdown += `- **Total Issues**: ${totalViolations}\n`;
              markdown += `- **Errors**: ${errorCount}\n`;
              markdown += `- **Warnings**: ${warningCount}\n`;
              markdown += `- **Info**: ${infoCount}\n`;
            }
            
            console.log(markdown);
          } catch (e) {
            console.log('## ðŸ¤– Code Review\n\nError parsing results: ' + e.message);
          }
          PARSER_EOF
          
            node /tmp/parse_violations.js > /tmp/comment.md
            cat /tmp/comment.md
          else
            echo "## ðŸ¤– Code Review" > /tmp/comment.md
            echo "" >> /tmp/comment.md
            if [ "${{ inputs.language }}" == "java" ]; then
              echo "No Java files detected in this PR" >> /tmp/comment.md
            else
              echo "Skipping review for language: ${{ inputs.language }}" >> /tmp/comment.md
            fi
            cat /tmp/comment.md
          fi
          
          # Store comment for next step
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/comment.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewComment = `${{ steps.parse-results.outputs.review_comment }}`;
            
            if (!reviewComment || reviewComment.trim().length === 0) {
              console.log('No review comment to post');
              return;
            }
            
            // Find existing review comment to update or create new one
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const existingComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸ¤– Automated Code Review')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewComment
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewComment
              });
              console.log('Posted new review comment');
            }

      - name: Check for critical issues
        id: check-critical
        run: |
          # If critical issues found, fail the check
          # This prevents merge until issues are resolved
          echo "critical_found=false" >> $GITHUB_OUTPUT

      - name: Set check status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const criticalFound = ${{ steps.check-critical.outputs.critical_found }};
            
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Code Review - ${{ inputs.language }}',
              head_sha: context.sha,
              status: 'completed',
              conclusion: criticalFound ? 'failure' : 'success',
              output: {
                title: 'Code Review Results',
                summary: 'Automated code review completed'
              }
            });
